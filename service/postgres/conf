#!/bin/sh

exec 2>&1
realpath "$0"
set -ex
cat >>"$PGDATA/postgresql.conf" <<EOF

auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_min_duration = 100
auto_explain.log_nested_statements = on
auto_explain.log_triggers = on
auto_explain.log_verbose = on
cluster_name = '$CLUSTER_NAME'
datestyle = 'iso, dmy'
listen_addresses = '*'
log_line_prefix = '%m [%p] %r %u@%d/%a '
max_connections = 128
max_logical_replication_workers = 0
max_sync_workers_per_subscription = 0
max_wal_senders = 0
max_worker_processes = 128
plpgsql.extra_warnings = all
plpgsql.print_strict_params = on
session_preload_libraries = 'auto_explain'
track_activity_query_size = 102400
wal_level = minimal
EOF
if [ -n "$SERVER_CERT" ]; then echo "ssl_cert_file = '$SERVER_CERT'" >>"$PGDATA/postgresql.conf"; fi
if [ -n "$SERVER_KEY" ]; then echo "ssl_key_file = '$SERVER_KEY'" >>"$PGDATA/postgresql.conf"; fi
if [ -n "$SSL_CA_FILE" ]; then echo "ssl_ca_file = '$SSL_CA_FILE'" >>"$PGDATA/postgresql.conf"; fi
if [ -n "$SSL_CRL_FILE" ]; then echo "ssl_crl_file = '$SSL_CRL_FILE'" >>"$PGDATA/postgresql.conf"; fi
if [ -n "$PG_AUTO_FAILOVER" ] && [ -z "$PG_AUTO_FAILOVER_MONITOR" ]; then
    cat >>"$PGDATA/postgresql.conf" <<EOF

shared_preload_libraries = 'pg_backtrace,pg_task,pg_partman_bgw,pg_stat_statements,pgautofailover'
EOF
else
    cat >>"$PGDATA/postgresql.conf" <<EOF

shared_preload_libraries = 'pg_backtrace,pg_task,pg_partman_bgw,pg_stat_statements'
EOF
fi
